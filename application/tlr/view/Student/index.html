<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>学生信息</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
<div id="app" class="container">
  <div class="row">
    <div class="col-sm-6 col-md-6 col-lg-6">
      <h3>学生信息</h3>
    </div>
    <div>
      <div class="input-group">
        <input type="text" class="form-control" v-model="searchSname"/>
        <button @click="search(searchSname)" class="btn btn btn-danger">搜索</button>
      </div>
    </div>
    <div>
      &nbsp;
      <button class="btn btn btn-success" @click="newStudent()">添加学生</button>
    </div>
  </div>

  <div>
    <table class="table table-striped">
      <thead>
        <tr>
          <td>#</td>
          <td>编号</td>
          <td>姓名</td>
          <td>性别</td>
          <td>年级</td>
          <td>学校</td>
          <!-- <td>家庭地址</td>
          <td>家庭电话</td>
          <td>联系电话</td>
          <td>账户余额</td>
          <td>备注</td> -->
          <td>操作</td>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(student,index) in students">
          <td>{{index+1}}</td>
          <td>{{student.sid}}</td>
          <td>{{student.sname}}</td>
          <td>{{student.sex}}</td>
          <td>{{student.grade}}</td>
          <td>{{student.school}}</td>
          <!-- <td>{{student.home}}</td>
          <td>{{student.tel}}</td>
          <td>{{student.phone}}</td>
          <td>{{student.balance}}</td>
          <td>{{student.memo}}</td> -->
          <td>
            <button class="btn btn-sm btn-success" @click="open(index)">详细信息</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div style="text-align:center;">
    <nav aria-label="Page navigation example">
      <ul class="pagination justify-content-center">
        <li class="page-item" @click="page(nowPage-1)">
          <span class="page-link">&laquo;</span>
        </li> 
        <li :class="(nowPage==i)?'page-item active':'page-item'" v-for="i in totolPage" @click="page(i)">
          <span class="page-link">{{i}}</span>
        </li>
        <li class="page-item" @click="page(nowPage+1)">
          <span class="page-link">&raquo;</span>
        </li>
      </ul>
    </nav>
  </div>

  <div>
    <div class="modal fade" tabindex="-1" id="myModal" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" >{{(add)?'添加用户':'修改用户'}}</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="row">
              
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  姓名: 
                  <input type="text" v-model="studentDetailInShow.sname" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                  性别:
                  <select class="form-control" v-model="studentDetailInShow.sex">
                    <option value="1">男</option>
                    <option value="2">女</option>
                  </select>
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  年级:  
                  <input type="text" v-model="studentDetailInShow.grade" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  学校: 
                  <input type="text" v-model="studentDetailInShow.school" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  家庭住址:
                  <input type="text" v-model="studentDetailInShow.home" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  家庭电话:  
                  <input type="text" v-model="studentDetailInShow.tel" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">
                
                  联系电话:  
                  <input type="text" v-model="studentDetailInShow.phone" class="form-control">
              </div>
              <div class="col-sm-6 col-md-6 col-lg-6">  
                  余额:  
                  <input type="text" v-model="studentDetailInShow.balance" disabled class="form-control">
              </div>
            </div>
            <div>
                  备注:  
                  <textarea v-model="studentDetailInShow.memo" class="form-control">
                  </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            <button v-if="add" class="btn btn-primary" @click="addStudent(studentDetailInShow)">添加学生</button>
            <button v-if="!add" type="button" class="btn btn-primary" @click="saveStudent(studentDetailInShow)">保存修改</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </div>




</div>
</body>
<script type="text/javascript">
var app = new Vue({
  el: '#app',
  data: {
    students: [],
    studentDetailInShow: {},
    nowPage:1,
    totolPage: 1,
    add: false,
    searchSname: '',
  },
  mounted () {
    this.getStudents(1)
  },
  methods: {
    getStudents (page) {
      let tvm = this
      $.ajax({
        type: "GET",
        url: "{:URL('tlr/student/students','','')}?page="+page,
        data: {},
        dataType: "json",
        success: function(data) {
          if(data.success) {
            tvm.students = data.students
            tvm.totolPage = data.totolPage
          } else {
            console.log("some troubles")
          }
        }
      });
    },
    page (newPage) {
      if (newPage < 1) {
        newPage = 1
      } else if (newPage > this.totolPage) {
        newPage = this.totolPage
      }
      this.getStudents(newPage)
    },
    open (index) {
      this.studentDetailInShow = this.students[index]
      this.add = false
      $('#myModal').modal();
    },
    newStudent () {
      this.studentDetailInShow = {}
      this.add = true
      $('#myModal').modal();
    },
    saveStudent (studentDetailInShow) {
      if(studentDetailInShow.sname == null || studentDetailInShow.sname.length<1) {
        alert ("用户名不能为空")
        return;
      }
      if(studentDetailInShow.phone == null || studentDetailInShow.phone.length<1) {
        alert ("用户名不能为空")
        return;
      }
      $.ajax({
        type: "POST",
        url: "{:URL('tlr/student/update','','')}",
        data: studentDetailInShow,
        dataType: "json",
        success: function(data) {
          if(data.success) {
            alert("操作成功")
          } else {
            alert(data.msg)
          }
        }
      });
    },
    addStudent (studentDetailInShow) {
      if(studentDetailInShow.sname == null || studentDetailInShow.sname.length<1) {
        alert ("用户名不能为空")
        return;
      }
      if(studentDetailInShow.phone == null || studentDetailInShow.phone.length<1) {
        alert ("用户名不能为空")
        return;
      }
      $.ajax({
        type: "POST",
        url: "{:URL('tlr/student/add','','')}",
        data: studentDetailInShow,
        dataType: "json",
        success: function(data) {
          if(data.success) {
            alert("操作成功")
          } else {
            alert(data.msg)
          }
        }
      });
    },
    search (searchSname) {
      let tvm = this
      if(searchSname == null || searchSname<1) {
        alert ("用户名为空无法搜索")
        return;
      }
      $.ajax({
        type: "GET",
        url: "{:URL('tlr/student/search','','')}?sname=" + searchSname,
        data: {},
        dataType: "json",
        success: function(data) {
          if(data.success) {
            tvm.students = data.students
            tvm.totolPage = 1   
          } else {
            alert(data.msg)
          }
        }
      });
    }
  }
})
</script>
</html>
